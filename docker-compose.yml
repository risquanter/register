services:
  # ============================================================================
  # Irmin GraphQL Server (Persistence Layer)
  # ============================================================================
  irmin:
    image: local/irmin:3.11  # prebuilt from dev/Dockerfile.irmin
    container_name: irmin-graphql
    ports:
      - "9080:8080"  # Expose on 9080 to avoid conflict with register-server
    volumes:
      - irmin-data:/data
    environment:
      # Irmin uses CLI args, not env vars, but we can set opam env
      OPAMROOT: /home/opam/.opam
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - --post-data='{\"query\":\"{ __typename }\"}' --header='Content-Type: application/json' http://127.0.0.1:8080/graphql | grep -q data"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - register-network
    profiles:
      - persistence  # Start with: docker compose --profile persistence up

  # ============================================================================
  # Risk Register Server (Native GraalVM on Distroless)
  # ============================================================================
  register-server:
    build:
      context: .
      dockerfile: Dockerfile.native
    container_name: register-server
    ports:
      - "8080:8080"
    environment:
      # Server configuration
      REGISTER_SERVER_HOST: "0.0.0.0"
      REGISTER_SERVER_PORT: "8080"
      
      # Simulation configuration
      REGISTER_DEFAULT_NTRIALS: "10000"
      REGISTER_MAX_TREE_DEPTH: "5"
      REGISTER_PARALLELISM: "8"
      REGISTER_MAX_CONCURRENT_SIMULATIONS: "4"
      REGISTER_MAX_NTRIALS: "1000000"
      REGISTER_MAX_PARALLELISM: "16"
      
      # CORS configuration
      REGISTER_CORS_ORIGINS: "http://localhost:3000,http://localhost:5173"
      
      # Telemetry configuration
      # NOTE: TracingLive.console & MetricsLive.console are configured but produce
      # no visible output (likely log at DEBUG level filtered by default log config).
      # For working telemetry: switch to TracingLive.otlp & MetricsLive.otlp, then run:
      # docker-compose --profile observability up
      OTEL_SERVICE_NAME: "risk-register"
      # OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"  # Unused with console exporters
    image: register-server:native
    read_only: true
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 256M
        reservations:
          cpus: '0.5'
          memory: 64M
    # Healthcheck disabled: distroless has no curl/shell
    # Use external monitoring: curl http://localhost:8080/health
    restart: unless-stopped
    networks:
      - register-network

  # OpenTelemetry Collector (optional - for observability)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.95.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics
      - "8889:8889"   # Prometheus exporter
    networks:
      - register-network
    profiles:
      - observability

networks:
  register-network:
    driver: bridge

volumes:
  irmin-data:
    driver: local
